# SpinePrep Minimal Workflow (A3 + A4)
# Consumes manifest.csv, applies MP-PCA denoising to BOLD series

import sys
from pathlib import Path

# Add repo root to path for imports
SYS_ROOT = Path(__file__).resolve().parents[1]
if str(SYS_ROOT) not in sys.path:
    sys.path.insert(0, str(SYS_ROOT))

# Get config from CLI (passed via --config or --configfile)
# Expected keys: bids_dir, out_dir, manifest_csv
BIDS_DIR = config.get("bids_dir", "")
OUT_DIR = config.get("out_dir", "./out")
MANIFEST_CSV = config.get("manifest_csv", f"{OUT_DIR}/manifest.csv")


# Include preprocessing and confounds rules
include: "rules/preproc.smk"
include: "rules/confounds.smk"


rule all:
    """Target rule that depends on manifest processing, denoising, and confounds."""
    input:
        touch=f"{OUT_DIR}/.manifest.touch",
        denoised=get_denoise_outputs(),
        confounds=get_confounds_outputs(),


rule touch_manifest:
    """Touch file to verify workflow execution."""
    input:
        manifest=MANIFEST_CSV,
    output:
        touch=f"{OUT_DIR}/.manifest.touch",
    shell:
        """
        echo "Manifest processed: {input.manifest}"
        wc -l {input.manifest}
        touch {output.touch}
        """
